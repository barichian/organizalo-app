services:
  web:
    build:
      context: .
      dockerfile: ./apps/web/Dockerfile.web
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    depends_on:
      - api
    environment:
      - WEB_URL=${WEB_URL}
      - API_BASE_URL=${API_BASE_URL}
      - APP_BASE_URL=${APP_BASE_URL}
      - ADMIN_BASE_URL=${ADMIN_BASE_URL}
      - SPACE_BASE_URL=${SPACE_BASE_URL}
      - LIVE_BASE_URL=${LIVE_BASE_URL}

  admin:
    build:
      context: .
      dockerfile: ./apps/admin/Dockerfile.admin
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    depends_on:
      - api
      - web
    environment:
      - WEB_URL=${WEB_URL}
      - API_BASE_URL=${API_BASE_URL}
      - ADMIN_BASE_URL=${ADMIN_BASE_URL}
      - ADMIN_BASE_PATH=${ADMIN_BASE_PATH}

  space:
    build:
      context: .
      dockerfile: ./apps/space/Dockerfile.space
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    depends_on:
      - api
      - web
    environment:
      - WEB_URL=${WEB_URL}
      - API_BASE_URL=${API_BASE_URL}
      - SPACE_BASE_URL=${SPACE_BASE_URL}
      - SPACE_BASE_PATH=${SPACE_BASE_PATH}

  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile.api
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    command: ./bin/docker-entrypoint-api.sh
    depends_on:
      - plane-db
      - plane-redis
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=${DEBUG:-0}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=${POSTGRES_HOST:-plane-db}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_HOST=${REDIS_HOST:-plane-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_URL=${REDIS_URL}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-plane-mq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-plane}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL}
      - AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME}
      - USE_MINIO=${USE_MINIO:-1}
      - MINIO_ENDPOINT_SSL=${MINIO_ENDPOINT_SSL:-0}
      - FILE_SIZE_LIMIT=${FILE_SIZE_LIMIT:-5242880}
      - WEB_URL=${WEB_URL}
      - API_BASE_URL=${API_BASE_URL}
      - APP_BASE_URL=${APP_BASE_URL}
      - APP_BASE_PATH=${APP_BASE_PATH}
      - ADMIN_BASE_URL=${ADMIN_BASE_URL}
      - ADMIN_BASE_PATH=${ADMIN_BASE_PATH}
      - SPACE_BASE_URL=${SPACE_BASE_URL}
      - SPACE_BASE_PATH=${SPACE_BASE_PATH}
      - LIVE_BASE_URL=${LIVE_BASE_URL}
      - LIVE_BASE_PATH=${LIVE_BASE_PATH}
      - LIVE_SERVER_SECRET_KEY=${LIVE_SERVER_SECRET_KEY}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS}
      - GUNICORN_WORKERS=${GUNICORN_WORKERS:-2}
      - API_KEY_RATE_LIMIT=${API_KEY_RATE_LIMIT}
      - WAHA_BASE_URL=${WAHA_BASE_URL:-http://whatsapp:3000}
      - WAHA_API_KEY=${WAHA_API_KEY:-plane}
      - DOCKERIZED=1

  worker:
    build:
      context: ./apps/api
      dockerfile: Dockerfile.api
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    command: ./bin/docker-entrypoint-worker.sh
    depends_on:
      - api
      - plane-db
      - plane-redis
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=${DEBUG:-0}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=${POSTGRES_HOST:-plane-db}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_HOST=${REDIS_HOST:-plane-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_URL=${REDIS_URL}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-plane-mq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-plane}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_S3_ENDPOINT_URL=${AWS_S3_ENDPOINT_URL}
      - AWS_S3_BUCKET_NAME=${AWS_S3_BUCKET_NAME}
      - USE_MINIO=${USE_MINIO:-1}
      - FILE_SIZE_LIMIT=${FILE_SIZE_LIMIT:-5242880}
      - DOCKERIZED=1

  beat-worker:
    build:
      context: ./apps/api
      dockerfile: Dockerfile.api
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    command: ./bin/docker-entrypoint-beat.sh
    depends_on:
      - api
      - plane-db
      - plane-redis
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=${DEBUG:-0}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=${POSTGRES_HOST:-plane-db}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_HOST=${REDIS_HOST:-plane-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_URL=${REDIS_URL}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-plane-mq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-plane}
      - DOCKERIZED=1

  migrator:
    build:
      context: ./apps/api
      dockerfile: Dockerfile.api
      args:
        DOCKER_BUILDKIT: 1
    restart: "no"
    command: ./bin/docker-entrypoint-migrator.sh
    depends_on:
      - plane-db
      - plane-redis
    environment:
      - SECRET_KEY=${SECRET_KEY}
      - DEBUG=${DEBUG:-0}
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=${POSTGRES_HOST:-plane-db}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - DATABASE_URL=${DATABASE_URL}
      - REDIS_HOST=${REDIS_HOST:-plane-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_URL=${REDIS_URL}
      - RABBITMQ_HOST=${RABBITMQ_HOST:-plane-mq}
      - RABBITMQ_PORT=${RABBITMQ_PORT:-5672}
      - RABBITMQ_USER=${RABBITMQ_USER}
      - RABBITMQ_PASSWORD=${RABBITMQ_PASSWORD}
      - RABBITMQ_VHOST=${RABBITMQ_VHOST:-plane}
      - DOCKERIZED=1

  live:
    build:
      context: .
      dockerfile: ./apps/live/Dockerfile.live
      args:
        DOCKER_BUILDKIT: 1
    restart: always
    depends_on:
      - plane-redis
      - api
    environment:
      - LIVE_SERVER_SECRET_KEY=${LIVE_SERVER_SECRET_KEY}
      - LIVE_BASE_URL=${LIVE_BASE_URL}
      - LIVE_BASE_PATH=${LIVE_BASE_PATH}
      - API_BASE_URL=${API_BASE_URL}
      - REDIS_HOST=${REDIS_HOST:-plane-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - REDIS_URL=${REDIS_URL}

  plane-db:
    image: postgres:15.7-alpine
    restart: always
    command: postgres -c 'max_connections=1000'
    volumes:
      - pgdata:/var/lib/postgresql/data
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${POSTGRES_DB}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - PGDATA=/var/lib/postgresql/data

  plane-redis:
    image: valkey/valkey:7.2.11-alpine
    restart: always
    volumes:
      - redisdata:/data

  whatsapp:
    image: devlikeapro/waha:latest
    restart: always
    environment:
      - WHATSAPP_DEFAULT_ENGINE=WEBJS
      - WHATSAPP_SWAGGER_USERNAME=admin
      - WHATSAPP_SWAGGER_PASSWORD=admin
      - WHATSAPP_API_KEY=${WAHA_API_KEY:-plane}
    volumes:
      - whatsapp_data:/app/sessions

  plane-mq:
    image: rabbitmq:3.13.6-management-alpine
    restart: always
    environment:
      - RABBITMQ_DEFAULT_USER=${RABBITMQ_USER}
      - RABBITMQ_DEFAULT_PASS=${RABBITMQ_PASSWORD}
      - RABBITMQ_DEFAULT_VHOST=${RABBITMQ_VHOST:-plane}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq

  plane-minio:
    image: minio/minio
    restart: always
    command: server /export --console-address ":9090"
    volumes:
      - uploads:/export
    environment:
      - MINIO_ROOT_USER=${AWS_ACCESS_KEY_ID}
      - MINIO_ROOT_PASSWORD=${AWS_SECRET_ACCESS_KEY}

  proxy:
    build:
      context: ./apps/proxy
      dockerfile: Dockerfile.ce
    restart: always
    environment:
      - FILE_SIZE_LIMIT=${FILE_SIZE_LIMIT:-5242880}
      - BUCKET_NAME=${AWS_S3_BUCKET_NAME:-uploads}
      - SITE_ADDRESS=:80
      - TRUSTED_PROXIES=0.0.0.0/0
    depends_on:
      - web
      - api
      - space
      - admin
      - live
      - whatsapp

volumes:
  pgdata:
  redisdata:
  uploads:
  rabbitmq_data:
  whatsapp_data:
